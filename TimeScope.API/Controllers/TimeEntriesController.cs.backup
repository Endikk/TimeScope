using Microsoft.AspNetCore.Mvc;using Microsoft.AspNetCore.Mvc;using Microsoft.AspNetCore.Mvc;

using Microsoft.AspNetCore.Authorization;

using TimeScope.Core.Entities;using Microsoft.AspNetCore.Authorization;using Microsoft.AspNetCore.Authorization;

using TimeScope.Core.Interfaces;

using TimeScope.Core.Entities;using TimeScope.Core.Entities;

namespace TimeScope.API.Controllers;

using TimeScope.Core.Interfaces;using TimeScope.Core.Interfaces;

[ApiController]

[Route("api/[controller]")]

[Authorize]

public class TimeEntriesController : ControllerBasenamespace TimeScope.API.Controllers;namespace TimeScope.API.Controllers;

{

    private readonly ITimeEntryService _timeEntryService;

    private readonly ILogger<TimeEntriesController> _logger;

[ApiController][ApiController]

    public TimeEntriesController(ITimeEntryService timeEntryService, ILogger<TimeEntriesController> logger)

    {[Route("api/[controller]")][Route("api/[controller]")]

        _timeEntryService = timeEntryService;

        _logger = logger;[Authorize][Authorize] // Tous les utilisateurs authentifiés peuvent gérer leurs entrées de temps

    }

public class TimeEntriesController : ControllerBasepublic class TimeEntriesController : ControllerBase

    [HttpGet]

    public async Task<ActionResult<IEnumerable<TimeEntryDto>>> GetAllTimeEntries({{

        [FromQuery] Guid? userId = null,

        [FromQuery] Guid? taskId = null,    private readonly ITimeEntryService _timeEntryService;    private readonly ITimeEntryService _timeEntryService;

        [FromQuery] DateTime? startDate = null,

        [FromQuery] DateTime? endDate = null)    private readonly ILogger<TimeEntriesController> _logger;    private readonly ILogger<TimeEntriesController> _logger;

    {

        try

        {

            var filter = new TimeEntryFilter    public TimeEntriesController(ITimeEntryService timeEntryService, ILogger<TimeEntriesController> logger)    public TimeEntriesController(ITimeEntryService timeEntryService, ILogger<TimeEntriesController> logger)

            {

                UserId = userId,    {    {

                TaskId = taskId,

                StartDate = startDate,        _timeEntryService = timeEntryService;        _timeEntryService = timeEntryService;

                EndDate = endDate

            };        _logger = logger;        _logger = logger;



            var timeEntries = await _timeEntryService.GetTimeEntriesAsync(filter);    }    }



            var result = timeEntries.Select(te => new TimeEntryDto

            {

                Id = te.Id.ToString(),    [HttpGet]    // GET: api/timeentries

                TaskId = te.TaskId.ToString(),

                UserId = te.UserId.ToString(),    public async Task<ActionResult<IEnumerable<TimeEntryDto>>> GetAllTimeEntries(    [HttpGet]

                Date = te.Date.ToString("yyyy-MM-ddTHH:mm:ss"),

                Duration = te.Duration.ToString(@"hh\:mm\:ss"),        [FromQuery] Guid? userId = null,    public async Task<ActionResult<IEnumerable<TimeEntryDto>>> GetAllTimeEntries(

                Notes = te.Notes

            });        [FromQuery] Guid? taskId = null,        [FromQuery] Guid? userId = null,



            return Ok(result);        [FromQuery] DateTime? startDate = null,        [FromQuery] Guid? taskId = null,

        }

        catch (Exception ex)        [FromQuery] DateTime? endDate = null)        [FromQuery] DateTime? startDate = null,

        {

            _logger.LogError(ex, "Error retrieving time entries");    {        [FromQuery] DateTime? endDate = null)

            return StatusCode(500, new { message = "An error occurred while retrieving time entries" });

        }        try    {

    }

        {        try

    [HttpGet("{id}")]

    public async Task<ActionResult<TimeEntryDto>> GetTimeEntry(Guid id)            var filter = new TimeEntryFilter        {

    {

        try            {            var filter = new TimeEntryFilter

        {

            var timeEntry = await _timeEntryService.GetTimeEntryByIdAsync(id);                UserId = userId,            {



            if (timeEntry == null)                TaskId = taskId,                UserId = userId,

            {

                return NotFound(new { message = "Time entry not found" });                StartDate = startDate,                TaskId = taskId,

            }

                EndDate = endDate                StartDate = startDate,

            var result = new TimeEntryDto

            {            };                EndDate = endDate

                Id = timeEntry.Id.ToString(),

                TaskId = timeEntry.TaskId.ToString(),            };

                UserId = timeEntry.UserId.ToString(),

                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),            var timeEntries = await _timeEntryService.GetTimeEntriesAsync(filter);

                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),

                Notes = timeEntry.Notes            var timeEntries = await _timeEntryService.GetTimeEntriesAsync(filter);

            };

            var result = timeEntries.Select(te => new TimeEntryDto

            return Ok(result);

        }            {            var result = timeEntries.Select(te => new TimeEntryDto

        catch (Exception ex)

        {                Id = te.Id.ToString(),            {

            _logger.LogError(ex, "Error retrieving time entry {Id}", id);

            return StatusCode(500, new { message = "An error occurred while retrieving the time entry" });                TaskId = te.TaskId.ToString(),                Id = te.Id.ToString(),

        }

    }                UserId = te.UserId.ToString(),                TaskId = te.TaskId.ToString(),



    [HttpPost]                Date = te.Date.ToString("yyyy-MM-ddTHH:mm:ss"),                UserId = te.UserId.ToString(),

    public async Task<ActionResult<TimeEntryDto>> CreateTimeEntry([FromBody] CreateTimeEntryDto dto)

    {                Duration = te.Duration.ToString(@"hh\:mm\:ss"),                Date = te.Date.ToString("yyyy-MM-ddTHH:mm:ss"),

        try

        {                Notes = te.Notes                Duration = te.Duration.ToString(@"hh\:mm\:ss"),

            var command = new CreateTimeEntryCommand

            {            });                Notes = te.Notes

                TaskId = dto.TaskId,

                UserId = dto.UserId,            });

                Date = dto.Date,

                Duration = dto.Duration,            return Ok(result);

                Notes = dto.Notes

            };        }            return Ok(result);



            var timeEntry = await _timeEntryService.CreateTimeEntryAsync(command);        catch (Exception ex)        }



            var result = new TimeEntryDto        {        catch (Exception ex)

            {

                Id = timeEntry.Id.ToString(),            _logger.LogError(ex, "Error retrieving time entries");        {

                TaskId = timeEntry.TaskId.ToString(),

                UserId = timeEntry.UserId.ToString(),            return StatusCode(500, new { message = "An error occurred while retrieving time entries" });            _logger.LogError(ex, "Error retrieving time entries");

                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),

                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),        }            return StatusCode(500, new { message = "An error occurred while retrieving time entries" });

                Notes = timeEntry.Notes

            };    }        }



            return CreatedAtAction(nameof(GetTimeEntry), new { id = timeEntry.Id }, result);    }

        }

        catch (ArgumentException ex)    [HttpGet("{id}")]

        {

            _logger.LogWarning(ex, "Validation error while creating time entry");    public async Task<ActionResult<TimeEntryDto>> GetTimeEntry(Guid id)    // GET: api/timeentries/{id}

            return BadRequest(new { message = ex.Message });

        }    {    [HttpGet("{id}")]

        catch (Exception ex)

        {        try    public async Task<ActionResult<TimeEntryDto>> GetTimeEntry(Guid id)

            _logger.LogError(ex, "Error creating time entry");

            return StatusCode(500, new { message = "An error occurred while creating the time entry" });        {    {

        }

    }            var timeEntry = await _timeEntryService.GetTimeEntryByIdAsync(id);        try



    [HttpPut("{id}")]        {

    public async Task<IActionResult> UpdateTimeEntry(Guid id, [FromBody] UpdateTimeEntryDto dto)

    {            if (timeEntry == null)            var timeEntry = await _timeEntryService.GetTimeEntryByIdAsync(id);

        try

        {            {

            var command = new UpdateTimeEntryCommand

            {                return NotFound(new { message = "Time entry not found" });            if (timeEntry == null)

                Duration = dto.Duration,

                Notes = dto.Notes,            }            {

                Date = dto.Date

            };                return NotFound(new { message = "Time entry not found" });



            await _timeEntryService.UpdateTimeEntryAsync(id, command);            var result = new TimeEntryDto            }



            return NoContent();            {

        }

        catch (KeyNotFoundException ex)                Id = timeEntry.Id.ToString(),            var result = new TimeEntryDto

        {

            _logger.LogWarning(ex, "Time entry {Id} not found", id);                TaskId = timeEntry.TaskId.ToString(),            {

            return NotFound(new { message = ex.Message });

        }                UserId = timeEntry.UserId.ToString(),                Id = timeEntry.Id.ToString(),

        catch (ArgumentException ex)

        {                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),                TaskId = timeEntry.TaskId.ToString(),

            _logger.LogWarning(ex, "Validation error while updating time entry {Id}", id);

            return BadRequest(new { message = ex.Message });                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),                UserId = timeEntry.UserId.ToString(),

        }

        catch (Exception ex)                Notes = timeEntry.Notes                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),

        {

            _logger.LogError(ex, "Error updating time entry {Id}", id);            };                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),

            return StatusCode(500, new { message = "An error occurred while updating the time entry" });

        }                Notes = timeEntry.Notes

    }

            return Ok(result);            };

    [HttpDelete("{id}")]

    public async Task<IActionResult> DeleteTimeEntry(Guid id)        }

    {

        try        catch (Exception ex)            return Ok(result);

        {

            var deleted = await _timeEntryService.DeleteTimeEntryAsync(id);        {        }



            if (!deleted)            _logger.LogError(ex, "Error retrieving time entry {Id}", id);        catch (Exception ex)

            {

                return NotFound(new { message = "Time entry not found" });            return StatusCode(500, new { message = "An error occurred while retrieving the time entry" });        {

            }

        }            _logger.LogError(ex, "Error retrieving time entry {Id}", id);

            return NoContent();

        }    }            return StatusCode(500, new { message = "An error occurred while retrieving the time entry" });

        catch (Exception ex)

        {        }

            _logger.LogError(ex, "Error deleting time entry {Id}", id);

            return StatusCode(500, new { message = "An error occurred while deleting the time entry" });    [HttpPost]    }

        }

    }    public async Task<ActionResult<TimeEntryDto>> CreateTimeEntry([FromBody] CreateTimeEntryDto dto)

}

    {    // POST: api/timeentries

public class TimeEntryDto

{        try    [HttpPost]

    public string Id { get; set; } = string.Empty;

    public string TaskId { get; set; } = string.Empty;        {    public async Task<ActionResult<TimeEntryDto>> CreateTimeEntry([FromBody] CreateTimeEntryDto dto)

    public string UserId { get; set; } = string.Empty;

    public string Date { get; set; } = string.Empty;            var command = new CreateTimeEntryCommand    {

    public string Duration { get; set; } = string.Empty;

    public string? Notes { get; set; }            {        try

}

                TaskId = dto.TaskId,        {

public class CreateTimeEntryDto

{                UserId = dto.UserId,            var command = new CreateTimeEntryCommand

    public string TaskId { get; set; } = string.Empty;

    public string UserId { get; set; } = string.Empty;                Date = dto.Date,            {

    public string Date { get; set; } = string.Empty;

    public string Duration { get; set; } = string.Empty;                Duration = dto.Duration,                TaskId = dto.TaskId,

    public string? Notes { get; set; }

}                Notes = dto.Notes                UserId = dto.UserId,



public class UpdateTimeEntryDto            };                Date = dto.Date,

{

    public string? Date { get; set; }                Duration = dto.Duration,

    public string? Duration { get; set; }

    public string? Notes { get; set; }            var timeEntry = await _timeEntryService.CreateTimeEntryAsync(command);                Notes = dto.Notes

}

            };

            var result = new TimeEntryDto

            {            var timeEntry = await _timeEntryService.CreateTimeEntryAsync(command);

                Id = timeEntry.Id.ToString(),

                TaskId = timeEntry.TaskId.ToString(),            var result = new TimeEntryDto

                UserId = timeEntry.UserId.ToString(),            {

                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),                Id = timeEntry.Id.ToString(),

                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),                TaskId = timeEntry.TaskId.ToString(),

                Notes = timeEntry.Notes                UserId = timeEntry.UserId.ToString(),

            };                Date = timeEntry.Date.ToString("yyyy-MM-ddTHH:mm:ss"),

                Duration = timeEntry.Duration.ToString(@"hh\:mm\:ss"),

            return CreatedAtAction(nameof(GetTimeEntry), new { id = timeEntry.Id }, result);                Notes = timeEntry.Notes

        }            };

        catch (ArgumentException ex)

        {            return CreatedAtAction(nameof(GetTimeEntry), new { id = timeEntry.Id }, result);

            _logger.LogWarning(ex, "Validation error while creating time entry");        }

            return BadRequest(new { message = ex.Message });        catch (ArgumentException ex)

        }        {

        catch (Exception ex)            _logger.LogWarning(ex, "Validation error while creating time entry");

        {            return BadRequest(new { message = ex.Message });

            _logger.LogError(ex, "Error creating time entry");        }

            return StatusCode(500, new { message = "An error occurred while creating the time entry" });        catch (Exception ex)

        }        {

    }            _logger.LogError(ex, "Error creating time entry");

            return StatusCode(500, new { message = "An error occurred while creating the time entry" });

    [HttpPut("{id}")]        }

    public async Task<IActionResult> UpdateTimeEntry(Guid id, [FromBody] UpdateTimeEntryDto dto)    }

    {

        try    // PUT: api/timeentries/{id}

        {    [HttpPut("{id}")]

            var command = new UpdateTimeEntryCommand    public async Task<IActionResult> UpdateTimeEntry(Guid id, [FromBody] UpdateTimeEntryDto dto)

            {    {

                Duration = dto.Duration,        try

                Notes = dto.Notes,        {

                Date = dto.Date            var command = new UpdateTimeEntryCommand

            };            {

                Duration = dto.Duration,

            await _timeEntryService.UpdateTimeEntryAsync(id, command);                Notes = dto.Notes,

                Date = dto.Date

            return NoContent();            };

        }

        catch (KeyNotFoundException ex)            await _timeEntryService.UpdateTimeEntryAsync(id, command);

        {

            _logger.LogWarning(ex, "Time entry {Id} not found", id);            return NoContent();

            return NotFound(new { message = ex.Message });        }

        }        catch (KeyNotFoundException ex)

        catch (ArgumentException ex)        {

        {            _logger.LogWarning(ex, "Time entry {Id} not found", id);

            _logger.LogWarning(ex, "Validation error while updating time entry {Id}", id);            return NotFound(new { message = ex.Message });

            return BadRequest(new { message = ex.Message });        }

        }        catch (ArgumentException ex)

        catch (Exception ex)        {

        {            _logger.LogWarning(ex, "Validation error while updating time entry {Id}", id);

            _logger.LogError(ex, "Error updating time entry {Id}", id);            return BadRequest(new { message = ex.Message });

            return StatusCode(500, new { message = "An error occurred while updating the time entry" });        }

        }        catch (Exception ex)

    }        {

            _logger.LogError(ex, "Error updating time entry {Id}", id);

    [HttpDelete("{id}")]            return StatusCode(500, new { message = "An error occurred while updating the time entry" });

    public async Task<IActionResult> DeleteTimeEntry(Guid id)        }

    {    }

        try

        {    // DELETE: api/timeentries/{id}

            var deleted = await _timeEntryService.DeleteTimeEntryAsync(id);    [HttpDelete("{id}")]

    public async Task<IActionResult> DeleteTimeEntry(Guid id)

            if (!deleted)    {

            {        try

                return NotFound(new { message = "Time entry not found" });        {

            }            var deleted = await _timeEntryService.DeleteTimeEntryAsync(id);



            return NoContent();            if (!deleted)

        }            {

        catch (Exception ex)                return NotFound(new { message = "Time entry not found" });

        {            }

            _logger.LogError(ex, "Error deleting time entry {Id}", id);

            return StatusCode(500, new { message = "An error occurred while deleting the time entry" });            return NoContent();

        }        }

    }        catch (Exception ex)

}        {

            _logger.LogError(ex, "Error deleting time entry {Id}", id);

public class TimeEntryDto            return StatusCode(500, new { message = "An error occurred while deleting the time entry" });

{        }

    public string Id { get; set; } = string.Empty;    }

    public string TaskId { get; set; } = string.Empty;}

    public string UserId { get; set; } = string.Empty;            if (!string.IsNullOrEmpty(dto.Date))

    public string Date { get; set; } = string.Empty;            {

    public string Duration { get; set; } = string.Empty;                if (!DateTime.TryParse(dto.Date, out var date))

    public string? Notes { get; set; }                {

}                    return BadRequest(new { message = "Invalid date format" });

                }

public class CreateTimeEntryDto                

{                // Ensure date is in UTC

    public string TaskId { get; set; } = string.Empty;                if (date.Kind == DateTimeKind.Unspecified)

    public string UserId { get; set; } = string.Empty;                {

    public string Date { get; set; } = string.Empty;                    date = DateTime.SpecifyKind(date, DateTimeKind.Utc);

    public string Duration { get; set; } = string.Empty;                }

    public string? Notes { get; set; }                else if (date.Kind == DateTimeKind.Local)

}                {

                    date = date.ToUniversalTime();

public class UpdateTimeEntryDto                }

{                

    public string? Date { get; set; }                timeEntry.Date = date;

    public string? Duration { get; set; }            }

    public string? Notes { get; set; }

}            // Update duration if provided

            if (!string.IsNullOrEmpty(dto.Duration))
            {
                if (!TimeSpan.TryParse(dto.Duration, out var duration))
                {
                    return BadRequest(new { message = "Invalid duration format. Expected HH:mm:ss" });
                }
                timeEntry.Duration = duration;
            }

            // Update notes
            if (dto.Notes != null)
            {
                timeEntry.Notes = dto.Notes;
            }

            timeEntry.UpdatedAt = DateTime.UtcNow;

            await _context.SaveChangesAsync();

            return NoContent();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error updating time entry {Id}", id);
            return StatusCode(500, new { message = "An error occurred while updating the time entry" });
        }
    }

    // DELETE: api/timeentries/{id}
    [HttpDelete("{id}")]
    public async Task<IActionResult> DeleteTimeEntry(Guid id)
    {
        try
        {
            var timeEntry = await _context.TimeEntries.FindAsync(id);

            if (timeEntry == null || timeEntry.IsDeleted)
            {
                return NotFound(new { message = "Time entry not found" });
            }

            // Soft delete
            timeEntry.IsDeleted = true;
            timeEntry.UpdatedAt = DateTime.UtcNow;

            await _context.SaveChangesAsync();

            return NoContent();
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error deleting time entry {Id}", id);
            return StatusCode(500, new { message = "An error occurred while deleting the time entry" });
        }
    }

    // GET: api/timeentries/statistics
    [HttpGet("statistics")]
    public async Task<ActionResult<TimeEntryStatistics>> GetStatistics(
        [FromQuery] Guid? userId = null,
        [FromQuery] DateTime? startDate = null,
        [FromQuery] DateTime? endDate = null)
    {
        try
        {
            var query = _context.TimeEntries
                .Where(te => !te.IsDeleted)
                .AsQueryable();

            if (userId.HasValue)
            {
                query = query.Where(te => te.UserId == userId.Value);
            }

            if (startDate.HasValue)
            {
                query = query.Where(te => te.Date >= startDate.Value);
            }

            if (endDate.HasValue)
            {
                query = query.Where(te => te.Date <= endDate.Value);
            }

            var timeEntries = await query.ToListAsync();

            var totalHours = timeEntries.Sum(te => te.Duration.TotalHours);
            var totalEntries = timeEntries.Count;

            var entriesByDate = timeEntries
                .GroupBy(te => te.Date.Date)
                .ToDictionary(g => g.Key.ToString("yyyy-MM-dd"), g => g.Count());

            var statistics = new TimeEntryStatistics
            {
                TotalEntries = totalEntries,
                TotalHours = totalHours,
                EntriesByDate = entriesByDate
            };

            return Ok(statistics);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error retrieving time entry statistics");
            return StatusCode(500, new { message = "An error occurred while retrieving statistics" });
        }
    }
}

// DTOs
public class TimeEntryDto
{
    public string Id { get; set; } = string.Empty;
    public string TaskId { get; set; } = string.Empty;
    public string UserId { get; set; } = string.Empty;
    public string Date { get; set; } = string.Empty;
    public string Duration { get; set; } = string.Empty;
    public string? Notes { get; set; }
}

public class CreateTimeEntryDto
{
    public string TaskId { get; set; } = string.Empty;
    public string UserId { get; set; } = string.Empty;
    public string Date { get; set; } = string.Empty;
    public string Duration { get; set; } = string.Empty;
    public string? Notes { get; set; }
}

public class UpdateTimeEntryDto
{
    public string? TaskId { get; set; }
    public string? UserId { get; set; }
    public string? Date { get; set; }
    public string? Duration { get; set; }
    public string? Notes { get; set; }
}

public class TimeEntryStatistics
{
    public int TotalEntries { get; set; }
    public double TotalHours { get; set; }
    public Dictionary<string, int> EntriesByDate { get; set; } = new();
}
