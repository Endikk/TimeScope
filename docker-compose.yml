services:
  # Base de données Admin - Gestion des utilisateurs, rôles, paramètres
  postgres-admin:
    image: postgres:16-alpine
    container_name: timescope-postgres-admin
    environment:
      POSTGRES_DB: timescope_admin
      POSTGRES_USER: svc_timescope_admin
      POSTGRES_PASSWORD: Admin8s60N5h7
    ports:
      - "5443:5432"
    volumes:
      - postgres_admin_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U svc_timescope_admin" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de données Projects - Gestion des projets et groupes
  postgres-projects:
    image: postgres:16-alpine
    container_name: timescope-postgres-projects
    environment:
      POSTGRES_DB: timescope_projects
      POSTGRES_USER: svc_timescope_projects
      POSTGRES_PASSWORD: Projects8s60N5
    ports:
      - "5444:5432"
    volumes:
      - postgres_projects_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U svc_timescope_projects" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de données Time - Gestion des tâches et entrées de temps
  postgres-time:
    image: postgres:16-alpine
    container_name: timescope-postgres-time
    environment:
      POSTGRES_DB: timescope_time
      POSTGRES_USER: svc_timescope_time
      POSTGRES_PASSWORD: Time8s60N5h7dd
    ports:
      - "5445:5432"
    volumes:
      - postgres_time_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U svc_timescope_time" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # Base de données Reports - Gestion des rapports et analytics
  postgres-reports:
    image: postgres:16-alpine
    container_name: timescope-postgres-reports
    environment:
      POSTGRES_DB: timescope_reports
      POSTGRES_USER: svc_timescope_reports
      POSTGRES_PASSWORD: Reports8s60N5
    ports:
      - "5446:5432"
    volumes:
      - postgres_reports_data:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U svc_timescope_reports" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin pour la gestion de toutes les bases de données
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: timescope-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@timescope.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - postgres-admin
      - postgres-projects
      - postgres-time
      - postgres-reports
    volumes:
      - pgadmin_data:/var/lib/pgadmin

  # n8n - Workflow Automation
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: timescope-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - GENERIC_TIMEZONE=Europe/Paris
      - TZ=Europe/Paris
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      - WEBHOOK_CORS_ORIGIN_WHITELIST=http://localhost:3000,http://localhost:5173,*
      - WEBHOOK_URL=http://localhost:5678/
      - N8N_EDITOR_BASE_URL=http://localhost:5678/
      - N8N_SECURE_COOKIE=false
    volumes:
      - n8n_data:/home/node/.n8n
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Ollama - Local LLM
  ollama:
    image: ollama/ollama:latest
    container_name: timescope-ollama
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama

  # Backend API
  timescope-api:
    build:
      context: .
      dockerfile: TimeScope.API/Dockerfile
    container_name: timescope-api
    ports:
      - "8080:8080"
    environment:
      - ConnectionStrings__AdminConnection=Host=postgres-admin;Port=5432;Database=timescope_admin;Username=svc_timescope_admin;Password=Admin8s60N5h7;
      - ConnectionStrings__ProjectsConnection=Host=postgres-projects;Port=5432;Database=timescope_projects;Username=svc_timescope_projects;Password=Projects8s60N5;
      - ConnectionStrings__TimeConnection=Host=postgres-time;Port=5432;Database=timescope_time;Username=svc_timescope_time;Password=Time8s60N5h7dd;
      - ConnectionStrings__ReportsConnection=Host=postgres-reports;Port=5432;Database=timescope_reports;Username=svc_timescope_reports;Password=Reports8s60N5;
      - ASPNETCORE_ENVIRONMENT=Development
    depends_on:
      postgres-admin:
        condition: service_healthy
      postgres-projects:
        condition: service_healthy
      postgres-time:
        condition: service_healthy
      postgres-reports:
        condition: service_healthy

  # Frontend React App
  timescope-frontend:
    build:
      context: TimeScope.Frontend
      dockerfile: Dockerfile
    container_name: timescope-frontend
    ports:
      - "3000:80"
    depends_on:
      - timescope-api

volumes:
  postgres_admin_data:
  postgres_projects_data:
  postgres_time_data:
  postgres_reports_data:
  pgadmin_data:
  n8n_data:
  ollama_data:
